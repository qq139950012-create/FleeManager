<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作台</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        body { background-color: #f3f6f9; font-family: -apple-system, sans-serif; min-height: 100vh; }
        .navbar-home { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .role-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #e8f2ff; color: #0061f2; font-weight: bold; }
        .status-bar { background: #2d3748; color: white; padding: 12px 0; margin-bottom: 20px; }
        .action-card { background: white; border: none; border-radius: 12px; padding: 15px; text-decoration: none; display: block; color: #2d3748; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .action-card:active { transform: scale(0.98); background: #f8f9fa; }
        .bg-gradient-header { background: linear-gradient(135deg, #2563eb 0%, #00ba94 100%); }
        .grid-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; border-radius: 12px; padding: 20px 10px; height: 100%; text-decoration: none; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s; }
        .grid-btn:active { transform: scale(0.95); background: #f1f5f9; }
        .grid-btn i { font-size: 28px; margin-bottom: 8px; }
        .grid-btn span { font-size: 14px; font-weight: bold; }
        .icon-circle { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }


    /* 修复扫码框：移除强制黑色背景，防止黑屏 */
    #reader {
        width: 100%;
        min-height: 300px;
        background: #f8f9fa;
        border-radius: 12px;
        overflow: hidden;
    }
</style>


</head>
<body>

<nav class="navbar navbar-home">
    <div class="container py-1 d-flex justify-content-between align-items-center">
        <span class="navbar-brand fw-bold text-dark fs-6"><i class="fas fa-truck-fast text-primary me-2"></i>智慧车队</span>
        <div class="d-flex align-items-center gap-2">
            <div class="text-end lh-1">
                <div class="fw-bold" style="font-size: 0.9rem;">{{ driver.name }}</div>
                <span class="role-badge">{{ driver.get_role_display }}</span>
            </div>
            <a href="{% url 'logout' %}" class="text-secondary ms-2"><i class="fas fa-power-off"></i></a>
        </div>
    </div>
</nav>

<div class="status-bar">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="small">
            <i class="far fa-calendar-alt opacity-75 me-1"></i>
            <span class="fw-bold">{% now "Y-m-d" %}</span>
        </div>


    {% if driver.role == 'driver' or driver.role == 'team_leader' %}
    <form method="post" action="{% url 'toggle_work_status' %}" class="m-0 d-flex align-items-center">
        {% csrf_token %}

        {% if driver.work_status == 'on_duty' %}
            <span class="small text-success me-2">● 在岗</span>

            {% if current_vehicle %}
                <!-- ✅ 有车作业中：下班灰色不可点击 -->
                <button type="button"
                        class="btn btn-secondary btn-sm rounded-pill px-3 py-1"
                        style="font-size: 0.8rem;"
                        disabled>
                    下班
                </button>
            {% else %}
                <!-- ✅ 没车：允许下班 -->
                <button type="submit"
                        class="btn btn-outline-danger btn-sm rounded-pill px-3 py-1"
                        style="font-size: 0.8rem;">
                    下班
                </button>
            {% endif %}

        {% else %}
            <span class="small text-white-50 me-2">休息中</span>
            <button type="submit"
                    class="btn btn-success btn-sm rounded-pill px-3 py-1"
                    style="font-size: 0.8rem;">
                上班
            </button>
        {% endif %}
    </form>
    {% endif %}
</div>


</div>

<div class="container pb-5">
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm border-0 py-2 small" role="alert">
            <i class="fas fa-info-circle me-1"></i> {{ message }}
            <button type="button" class="btn-close p-2" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}


{% if driver.role == 'driver' or driver.role == 'team_leader' %}

    {% if current_vehicle %}
    <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden bg-gradient-header text-white">
        <div class="card-body p-4 text-center">
            <div class="opacity-75 small mb-1">正在驾驶</div>
            <h2 class="fw-bold mb-0">{{ current_vehicle.plate_number }}</h2>
            <div class="mt-2"><span class="badge bg-white text-primary bg-opacity-90 rounded-pill px-3">作业中</span></div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-6"><a href="{% url 'vehicle_add' current_vehicle.id 'fuel' %}" class="grid-btn"><div class="icon-circle bg-primary bg-opacity-10 text-primary mb-2"><i class="fas fa-gas-pump"></i></div><span>加油</span></a></div>
        <div class="col-6"><a href="{% url 'vehicle_add' current_vehicle.id 'urea' %}" class="grid-btn"><div class="icon-circle bg-info bg-opacity-10 text-info mb-2"><i class="fas fa-flask"></i></div><span>加尿素</span></a></div>
        <div class="col-6"><a href="{% url 'vehicle_add' current_vehicle.id 'charge' %}" class="grid-btn"><div class="icon-circle bg-warning bg-opacity-10 text-warning mb-2"><i class="fas fa-bolt"></i></div><span>充电</span></a></div>
        <div class="col-6"><a href="{% url 'add_repair' current_vehicle.id %}" class="grid-btn"><div class="icon-circle bg-danger bg-opacity-10 text-danger mb-2"><i class="fas fa-tools"></i></div><span>故障报修</span></a></div>
    </div>

    <a href="{% url 'vehicle_end' current_vehicle.id %}" class="btn btn-outline-danger w-100 py-3 rounded-4 fw-bold shadow-sm mb-5">
        <i class="fas fa-power-off me-2"></i>结束作业 / 收车回库
    </a>

    {% else %}

        {% if driver.role == 'team_leader' %}
        <div class="mb-4">
            <a href="{% url 'team_dashboard' %}" class="action-card d-flex align-items-center">
                <div class="theme-icon text-purple me-3">
                    <i class="fas fa-users-cog"></i>
                </div>
                <div>
                    <div class="fw-bold">班组管理</div>
                    <div class="small text-muted">管理考勤与奖金</div>
                </div>
            </a>
        </div>
        {% endif %}

        <div class="mb-4">
            <div class="card border-0 shadow-sm rounded-4 bg-gradient-header text-white text-center p-4">
                <div class="mb-3 opacity-75 small">快速开始任务</div>

                {% if driver.work_status == 'on_duty' %}
                <button type="button" class="btn btn-light btn-lg rounded-pill px-5 fw-bold text-primary shadow-sm"
                        data-bs-toggle="modal" data-bs-target="#scanModal">
                    <i class="fas fa-qrcode me-2"></i> 扫码绑定车辆
                </button>
                <div class="mt-3 small opacity-50">点击调用摄像头扫描</div>
                {% else %}
                <button type="button" class="btn btn-secondary btn-lg rounded-pill px-5 fw-bold shadow-sm" disabled>
                    <i class="fas fa-lock me-2"></i> 请先上班
                </button>
                <div class="mt-3 small opacity-75">上班后才可以扫码绑定车辆</div>
                {% endif %}
            </div>
        </div>

        <h6 class="fw-bold text-secondary mb-3 small"><i class="fas fa-list me-2"></i>空闲车辆列表</h6>
        <div class="row g-2 mb-4">
            {% for v in idle_vehicles %}
            <div class="col-6">
                {% if driver.work_status == 'on_duty' %}
                <a href="{% url 'vehicle_dashboard' v.id %}" class="card border-0 shadow-sm h-100 text-decoration-none text-dark">
                    <div class="card-body p-3 text-center">
                        <div class="fw-bold text-primary mb-1">{{ v.plate_number }}</div>
                        <div class="small text-muted" style="font-size: 11px;">{{ v.brand_model|truncatechars:8 }}</div>
                    </div>
                </a>
                {% else %}
                <div class="card border-0 shadow-sm h-100 text-decoration-none text-dark" style="opacity:0.55;">
                    <div class="card-body p-3 text-center">
                        <div class="fw-bold text-secondary mb-1">{{ v.plate_number }}</div>
                        <div class="small text-muted" style="font-size: 11px;">{{ v.brand_model|truncatechars:8 }}</div>
                        <div class="small text-danger mt-1" style="font-size: 11px;"><i class="fas fa-lock me-1"></i>请先上班</div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <div class="col-12">
                <div class="card border-0 bg-light text-center py-4 rounded-3 text-muted small">无空闲车辆</div>
            </div>
            {% endfor %}
        </div>

    {% endif %}  {# ✅ 结束 current_vehicle if/else #}

    <h6 class="fw-bold text-secondary mb-3 mt-4"><i class="fas fa-tasks me-2"></i>我的任务</h6>
    <div class="row g-3">
        {% for task in my_tasks %}
        <div class="col-12">
            <div class="card border-0 shadow-sm border-start border-4 border-primary p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">{{ task.title }}</div>
                        <div class="small text-muted">{{ task.detail }}</div>
                    </div>
                    <a href="{% url 'complete_task' task.id %}" class="btn btn-sm btn-outline-success rounded-pill px-3">完成</a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-muted small text-center py-3">暂无进行中的任务</div>
        {% endfor %}
    </div>

{% endif %} {# ✅ 结束 driver/team_leader 大块 #}

{% if driver.role == 'repairman' %}
    <div class="row g-3 mt-1">
        <div class="col-6"><a href="{% url 'repair_dashboard' %}" class="action-card text-center h-100"><i class="fas fa-tools text-danger fa-2x mb-2"></i><div class="fw-bold">维修接单</div></a></div>
        <div class="col-6"><a href="{% url 'inventory_list' %}" class="action-card text-center h-100"><i class="fas fa-boxes text-warning fa-2x mb-2"></i><div class="fw-bold">库存查询</div></a></div>
    </div>
{% endif %}


</div>

<div class="modal fade" id="scanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">扫描车辆二维码</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="reader"></div>
                <div id="status-msg" class="text-center text-muted small mt-2">正在启动摄像头...</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>

<script>
    const scanModal = document.getElementById('scanModal');
    let html5QrCode;
    const isOnDuty = "{{ driver.work_status }}" === "on_duty";

    scanModal.addEventListener('shown.bs.modal', function () {

        // ✅ 未上班：不允许启动摄像头
        if (!isOnDuty) {
            document.getElementById('reader').innerHTML =
                '<div class="alert alert-warning mb-0">请先点击【上班】后再扫码绑定车辆</div>';
            document.getElementById('status-msg').innerText = '扫码已锁定';
            return;
        }

        // ✅ 延迟启动，避免黑屏
        setTimeout(() => {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                console.log(`Result: ${decodedText}`);
                if (decodedText.includes("/scan/") && decodedText.includes("/start/")) {
                    if (navigator.vibrate) navigator.vibrate(200);
                    window.location.href = decodedText;
                    html5QrCode.stop();
                }
            }, (err) => {
                // 忽略识别中的错误
            }).catch(err => {
                console.error(err);
                document.getElementById('reader').innerHTML = '<div class="alert alert-danger">无法启动摄像头，请检查权限</div>';
                document.getElementById('status-msg').innerText = '启动失败';
            });

            document.getElementById('status-msg').innerText = '请对准二维码';
        }, 500);
    });

    scanModal.addEventListener('hidden.bs.modal', function () {
        if (html5QrCode) {
            html5QrCode.stop().then(() => html5QrCode.clear()).catch(err => {});
        }
    });
</script>

</body>
</html>
