<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>维修成本分析</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.1/echarts.min.js"></script>
    <style>
        body { background-color: #f3f6f9; font-family: 'Segoe UI', Roboto, sans-serif; }
        .dashboard-card { border: none; border-radius: 12px; background: white; box-shadow: 0 2px 12px rgba(0,0,0,0.04); margin-bottom: 20px; }
    </style>
</head>
<body class="pb-5">

    <nav class="navbar navbar-dark bg-danger mb-4 shadow-sm" style="background: linear-gradient(45deg, #be2617, #e74a3b);">
        <div class="container-fluid px-4">
            <span class="navbar-brand fw-bold"><i class="fas fa-wrench me-2"></i>维修成本透视</span>
            <a href="{% url 'leader_dashboard' %}" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-1"></i>返回驾驶舱</a>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="dashboard-card p-4 text-center">
                    <div class="text-muted small text-uppercase">本月维修总支出</div>
                    <div class="h2 fw-bold text-danger mb-0">¥{{ month_cost }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card p-4 text-center">
                    <div class="text-muted small text-uppercase">历史累计支出</div>
                    <div class="h2 fw-bold text-dark mb-0">¥{{ total_cost }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card p-4 text-center">
                    <div class="text-muted small text-uppercase">当前正在维修</div>
                    <div class="h2 fw-bold text-warning mb-0">{{ current_fixing }} <small class="fs-6 text-muted">辆</small></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="dashboard-card p-4" style="height: 400px;">
                    <h5 class="fw-bold text-dark mb-4">近半年维修费用趋势</h5>
                    <div id="trendChart" style="width: 100%; height: 300px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="dashboard-card p-4" style="height: 400px;">
                    <h5 class="fw-bold text-dark mb-4">高发故障类型分布</h5>
                    <div id="pieChart" style="width: 100%; height: 300px;"></div>
                </div>
            </div>
        </div>

        <div class="dashboard-card p-4">
            <h5 class="fw-bold text-danger mb-3"><i class="fas fa-clock me-2"></i>滞留预警：维修超过3天未完工</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr><th>车牌号</th><th>故障类型</th><th>报修时间</th><th>已耗时</th><th>当前技师</th></tr>
                    </thead>
                    <tbody>
                        {% for item in stuck_vehicles %}
                        <tr>
                            <td class="fw-bold">{{ item.vehicle.plate_number }}</td>
                            <td><span class="badge bg-secondary">{{ item.fault_type }}</span></td>
                            <td>{{ item.create_at|date:"Y-m-d H:i" }}</td>
                            <td class="text-danger fw-bold">{{ item.create_at|timesince }}</td>
                            <td>{{ item.repairman.name|default:"未分配" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center text-muted py-3">表现良好，无滞留车辆</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 趋势图
        var trendChart = echarts.init(document.getElementById('trendChart'));
        trendChart.setOption({
            tooltip: { trigger: 'axis' },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: JSON.parse('{{ trend_labels|safe }}') },
            yAxis: { type: 'value' },
            series: [{
                data: JSON.parse('{{ trend_data|safe }}'),
                type: 'bar',
                itemStyle: { color: '#e74a3b', borderRadius: [5, 5, 0, 0] },
                barWidth: '40%'
            }]
        });

        // 饼图
        var pieChart = echarts.init(document.getElementById('pieChart'));
        var pieLabels = JSON.parse('{{ pie_labels|safe }}');
        var pieValues = JSON.parse('{{ pie_data|safe }}');
        var pieData = pieLabels.map((label, i) => ({ value: pieValues[i], name: label }));
        
        pieChart.setOption({
            tooltip: { trigger: 'item' },
            legend: { bottom: '0', left: 'center' },
            series: [{
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                data: pieData
            }]
        });

        window.onresize = function() { trendChart.resize(); pieChart.resize(); };
    </script>
<script>
    // === 配置区 ===
    const REFRESH_SECONDS = 60; // 维修数据变化慢，设为60秒即可
    // ============

    let timeLeft = REFRESH_SECONDS;
    
    const timerBadge = document.createElement('div');
    timerBadge.style.cssText = "position:fixed; top:70px; right:20px; background:rgba(0,0,0,0.6); color:white; padding:5px 10px; border-radius:20px; font-size:12px; z-index:9999;";
    timerBadge.innerHTML = `<i class="fas fa-sync-alt fa-spin me-1"></i> ${timeLeft}s 后刷新`;
    document.body.appendChild(timerBadge);

    setInterval(function() {
        timeLeft--;
        if (timeLeft <= 0) {
            window.location.reload();
        } else {
            timerBadge.innerHTML = `<i class="fas fa-clock me-1"></i> ${timeLeft}s 后刷新`;
        }
    }, 1000);
</script>
</body>
</html>