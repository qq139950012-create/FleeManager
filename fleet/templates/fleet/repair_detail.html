<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>维修作业</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f3f6f9; font-family: -apple-system, sans-serif; padding-bottom: 100px; }
        .bg-header { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); padding-bottom: 2rem; border-radius: 0 0 20px 20px; margin-bottom: -40px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); margin-bottom: 1rem; }
        .dashed-btn { border: 2px dashed #dee2e6; color: #6c757d; background: #fff; }
    </style>
</head>
<body>
    <div class="bg-header pt-4 px-3 shadow-sm text-white">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h5 class="fw-bold mb-0"><i class="fas fa-tools me-2"></i>维修作业</h5>
            <a href="{% url 'repair_dashboard' %}" class="btn btn-sm btn-light text-danger rounded-pill px-3 fw-bold"><i class="fas fa-arrow-left me-1"></i>返回</a>
        </div>
    </div>

    <div class="container" style="margin-top: 20px;">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="fw-bold mb-0">{{ repair.vehicle.plate_number }}</h4>
                    <span class="badge bg-primary">维修中</span>
                </div>
                
                <div class="mb-3">
                    <span class="badge bg-danger bg-opacity-10 text-danger fs-6 px-3 py-2">
                        <i class="fas fa-exclamation-triangle me-1"></i> {{ repair.fault_text }}
                    </span>
                </div>

                <div class="text-muted small mb-3">报修人：{{ repair.driver.name }} | {{ repair.create_at|date:"Y-m-d H:i" }}</div>
                
                <div class="p-3 bg-light rounded text-secondary">
                    <span class="fw-bold text-dark">详细描述：</span>
                    {% if repair.content %}
                        {{ repair.content }}
                    {% else %}
                        <span class="text-muted fst-italic">（司机未填写详细描述）</span>
                    {% endif %}
                </div>
                
                {% if repair.images %}
                <div class="mt-3">
                    <a href="{{ repair.images.url }}" target="_blank" class="btn btn-sm btn-outline-secondary rounded-pill"><i class="fas fa-image me-1"></i>查看故障照片</a>
                </div>
                {% endif %}
            </div>
        </div>

        <h6 class="fw-bold text-secondary ps-2 mb-2 mt-4">配件消耗</h6>
        <div class="card">
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for usage in used_parts %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <div><div class="fw-bold">{{ usage.part.name }}</div><div class="small text-muted">{{ usage.part.spec }}</div></div>
                        <span class="badge bg-light text-dark border px-3 py-2">x {{ usage.quantity }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center text-muted py-4 small">暂未添加配件</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card-footer bg-white border-0 p-3">
                <button class="btn dashed-btn w-100 py-2 fw-bold rounded-pill" data-bs-toggle="modal" data-bs-target="#addPartModal"><i class="fas fa-plus me-1"></i> 添加配件</button>
            </div>
        </div>
    </div>

    <div class="fixed-bottom bg-white p-3 border-top shadow-lg">
        <form method="post" action="{% url 'repair_complete' repair.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success w-100 py-3 fw-bold rounded-pill shadow" onclick="return confirm('确定维修已完成？车辆将恢复为空闲状态。')"><i class="fas fa-check-circle me-2"></i>维修完成 / 释放车辆</button>
        </form>
    </div>

    <div class="modal fade" id="addPartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0"><h5 class="modal-title fw-bold">领用配件</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form method="post" action="{% url 'repair_add_part' repair.id %}">
                        {% csrf_token %}
                        <div class="mb-3"><label class="form-label small fw-bold">选择配件</label><select name="part_id" class="form-select" required><option value="" selected disabled>请选择...</option>{% for part in all_parts %}<option value="{{ part.id }}">{{ part.name }} (余: {{ part.stock }})</option>{% endfor %}</select></div>
                        <div class="mb-4"><label class="form-label small fw-bold">数量</label><input type="number" name="quantity" class="form-control" value="1" min="1" required></div>
                        <div class="d-grid"><button type="submit" class="btn btn-primary rounded-pill">确认领用</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
</body>
</html>